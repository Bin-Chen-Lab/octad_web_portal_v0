import json, os, subprocess
import collections
from datetime import datetime
from flask import Blueprint, request, render_template, url_for
from app import app
from models.dashboard import get_diseases, Samples, Job, STATUS
from models.profile import User
from zipfile import ZipFile, ZIP_DEFLATED
from custom_email import send_email
from sqlalchemy import or_
rscript_path = app.config['RSCRIPT_PATH']
rdir_path = app.config['RREPO_PATH']
r_output = app.config['RREPO_OUTPUT']
base_url = app.config['BASE_URL']

apiRoute = Blueprint('api', __name__)


@apiRoute.route('/sample/api', methods=["POST"])
# @csrf.exempt
def sampleApi():
	"""
	json of job information
	:return: json object
	"""
	filter_str = []
	if request.method == 'POST':
		data = request.get_json(force=True)
		for feature in data:
			if feature == 'disease_name':
				disease_name = data['disease_name'].strip()
				filter_str.append(Samples.cancer == disease_name)
			elif feature == 'tissue_type':
				tissue_type = data['tissue_type'] # ['primary', 'secoundry']
				filter_str.append(or_(Samples.tissue_type.in_(tissue_type)))
			elif feature == 'site':
				site = data['site']
				filter_str.append(Samples.site == site)
			elif feature == 'gender':
				gender = data['gender']
				filter_str.append(Samples.gender == gender)
			elif feature == 'metastatic':
				metastatic = data['metastatic']
				filter_str.append(Samples.metastatic_site == metastatic)
			elif feature == 'EGFR':
				EGFR = data['EGFR']
				filter_str.append(Samples.EGFR == EGFR)
			elif feature == 'IDH1':
				IDH1 = data['IDH1']
				filter_str.append(Samples.IDH1 == IDH1)
			elif feature == 'IDH2':
				IDH2 = data['IDH2']
				filter_str.append(Samples.IDH2 == IDH2)
			elif feature == 'TP53':
				TP53 = data['TP53']
				filter_str.append(Samples.TP53 == TP53)
			elif feature == 'tumour_geade':
				tumor_grade = data['tumour_geade']
				filter_str.append(Samples.tumor_grade == tumor_grade)
			elif feature == 'tumour_stage':
				tumour_stage = data['tumour_stage']
				filter_str.append(Samples.tumor_stage == tumour_stage)

	print "$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$", filter_str
	samples = Samples.query.filter(*filter_str).all()
	print samples
	sampleList = []
	for sample in samples:
		d = collections.OrderedDict()
		d['id'] = sample.id
		d['sample_id'] = sample.sample_id
		d['tissue_type'] = sample.tissue_type
		d['age_in_year'] = sample.age_in_year
		d['site'] = sample.site
		d['gender'] = sample.gender
		d['metastatic_site'] = sample.metastatic_site
		d['cancer'] = sample.cancer
		d['egfr'] = 1 if sample.EGFR else 0
		d['idh1'] = 1 if sample.IDH1 else 0
		d['idh2'] = 1 if sample.IDH2 else 0
		d['tp53'] = 1 if sample.TP53 else 0
		d['tumor_grade'] = sample.tumor_grade
		d['tumor_stage'] = sample.tumor_stage
		sampleList.append(d)

	return json.dumps(sampleList)


@apiRoute.route('/sample/control/api', methods=["POST"])
# @csrf.exempt
def controlSampleApi():
	"""
	json of job information
	:return: json object
	"""
	site = ''
	sample_list = []
	if request.method == 'POST':
		data = request.get_json(force=True)
		job_id = data['job_id']
		file_path = os.path.join(app.config['RREPO_OUTPUT'], str(job_id), data['file_name'])
		f = open(file_path, 'r')
		lines = f.readlines()
		site = lines[0].replace('\n', '')
		control_id = [line.replace('\n', '').replace('-', '.') for line in lines[1:]]
		samples = Samples.query.filter(Samples.sample_id.in_(control_id)).all()
		for sample in samples:
			d = collections.OrderedDict()
			d['id'] = sample.id
			d['sample_id'] = sample.sample_id
			d['tissue_type'] = sample.tissue_type
			d['age_in_year'] = sample.age_in_year
			d['site'] = sample.site
			d['gender'] = sample.gender
			d['metastatic_site'] = sample.metastatic_site
			d['cancer'] = sample.cancer
			d['egfr'] = 1 if sample.EGFR else 0
			d['idh1'] = 1 if sample.IDH1 else 0
			d['idh2'] = 1 if sample.IDH2 else 0
			d['tp53'] = 1 if sample.TP53 else 0
			d['tumor_grade'] = sample.tumor_grade
			d['tumor_stage'] = sample.tumor_stage
			sample_list.append(d)
		job = Job.query.filter(Job.id == job_id).first()
		site = site.split("-")[0].replace(' ', '').upper()
		job.update(commit=True, site=site)
	data = {"site": site, "samples": sample_list}
	return json.dumps(data)


@apiRoute.route('/diseases', methods=["GET"])
# @csrf.exempt
def diseases():
	diseases = get_diseases()
	return json.dumps(diseases)


@apiRoute.route('/job/api', methods=["GET"])
# @csrf.exempt
def jobApi():
	"""
	json of job information
	:return: json object
	"""
	user_id = User.query.filter_by(username='admin').first().id
	jobs = Job.query.filter(Job.user_id == user_id)
	jobList = []
	for job in jobs:
		jobList.append([job.id, job.name, STATUS[job.status], job.disease_name, job.gdc_project_id,
						job.mutation_gene, job.site, 'details'])
	data = {"data": jobList}
	return json.dumps(data)


@apiRoute.route('/job/api/<user_id>', methods=["GET"])
# @csrf.exempt
def userJobApi(user_id):
	"""
	json of job information
	:return: json object
	"""
	jobs = Job.query.filter(Job.user_id == user_id, Job.is_save == True).order_by(Job.id.desc()).all()
	jobs_list = []
	for job in jobs:
		d = dict()
		d['id'] = job.id
		d['job_name'] = job.name
		d['disease'] = job.disease
		d['status'] = STATUS[job.status]
		jobs_list.append(d)
	return json.dumps(jobs_list)


@apiRoute.route('/job/status', methods=["GET"])
# @csrf.exempt
def jobStatus():
	"""
	json of job information
	:return: json object
	"""

	jobs = Job.query.filter(Job.status <= 5).all()
	# jobs = Job.query.filter(Job.status == 6).all()
	for job in jobs:
		job_id = job.id
		if job.status <= 5 and (job.is_save == 0 or not job.is_save) and job.creationTime.date() < datetime.utcnow().date():
			# Removed unwanted jobs
			job.delete(commit=True)
		elif check_pdf(job_id):
			job.update(commit=True, status=6)
			file_folder = os.path.join(app.config['RREPO_OUTPUT'], str(job.id))
			file_name = job.name.replace(' ', '_') + '.zip'
			file_path = os.path.join(file_folder, file_name)
			if not os.path.exists(file_path):
				fantasy_zip = ZipFile(file_path, 'w')
				for folder, subfolders, files in os.walk(file_folder):
					for file in files:
						if file.endswith('.pdf') or file.endswith('.csv'):
							fantasy_zip.write(os.path.join(folder, file),
											  os.path.relpath(os.path.join(folder, file), file_folder),
											  compress_type=ZIP_DEFLATED)
				fantasy_zip.close()
				job_url = base_url + url_for('dashboard.job_output', job_id=job.id)
				subject = "OCTAD: %s Status" % job.name
				text = ""
				html = render_template('emails/job_status.html', job=job, job_url=job_url)
				send_email(job.userDetails.username, subject, text, html)

	return json.dumps("script completed")


def check_pdf(job_id):
	stat_path = app.config['APPLICATION_ROOT'] + '/static/data/' + str(job_id) + '/'
	flag = False
	for root, dirs, files in os.walk(stat_path):
		for file in files:
			if file.startswith("drug_enriched"):
				flag = True
	return flag


@apiRoute.route('/job/rerun', methods=["GET"])
# @csrf.exempt
def jobRerun():
	"""
	json of job information
	:return: json object
	"""

	jobs = Job.query.filter(Job.status == 5).all()
	for job in jobs:
		cmd = [rscript_path, rdir_path + 'drug_predict.R', str(job.id), 'T', str(50), str(1), 'F', 'T']
		x = subprocess.Popen(cmd)
