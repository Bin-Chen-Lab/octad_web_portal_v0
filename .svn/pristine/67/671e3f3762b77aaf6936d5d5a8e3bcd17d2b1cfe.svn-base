<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Octad</title>
	{% include 'base/css_links.html' %}

	<style type="text/css">
    .ui-autocomplete {
        height: 200px;
        overflow-y: scroll;
        overflow-x: hidden;
    }
	table.dataTable tr th.select-checkbox.selected::after {
        content: "âœ”";
        margin-top: -11px;
        margin-left: -4px;
        text-align: center;
        text-shadow: rgb(176, 190, 217) 1px 1px, rgb(176, 190, 217) -1px -1px, rgb(176, 190, 217) 1px -1px, rgb(176, 190, 217) -1px 1px;
	}
</style>
</head>

<body class=""><!-- mini-navbar -->
    <div id="wrapper">
        {% include 'base/navBar.html' %}
	    
        <div class="navbar-header navToggleBtn">
            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary m-n" href="#"><i class="fa fa-bars"></i> </a>
        </div>
		
		{% include 'base/header.html' %}
		
		<div id="page-wrapper" class="gray-bg sideNavBody"><!-- btmNavBody -->
            <div class="wrapper wrapper-content full-height" style="width : 99%">
                <div class="row" style="margin-bottom: 5px;">
                    <div class="col-lg-12">
                        <div class="ibox-content" style="border: 2px solid lightgray; border-radius: 5px;">
                            <span style="font-size: 14px;color: #0ca90c;">
                                <strong>Job Name : </strong>
                            </span>
                            <span style=" margin-left: 1%;margin-right: 5%; font-weight: 900;">{{ job.name }}</span>
                            <span style="font-size: 14px;color: #0ca90c;">
                                <strong>Creation Date : </strong>
                            </span>
                            <span style=" margin-left: 1%;margin-right: 5%; font-weight: 900;">{{ job.creationTime }}</span>
                            <span style="font-size: 14px;color: #0ca90c;">
                                <strong>Job Description : </strong>
                            </span>
                            <span style=" margin-left: 1%;font-weight: 900;">{{ job.description }}</span>
                            <span style="float: right;"><button id="drugsFiles">Download Related Files</button></span>
                       </div>
                   </div>
                </div>


            <!-- Drugs Panel Start-->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox ">
                            <div class="ibox-title" style="background: #009ece; color: white;">
                                <h5 class="pull-left">Drugs Prediction</h5>
                            </div>
                            <div class="ibox-content">
                            <!--   Drug hits graph -->
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="ibox ">
                                            <div class="ibox-title">
                                                <h5 class="pull-left">Drug Hits</h5>
                                            </div>
                                            <div class="ibox-content">
                                                <iframe src="{{ drug_file }}" width="1050" height="400"></iframe>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            <!--   targets pathway meshterms graph -->
                                <div class="row">
                                    {% for k, v in drug_enricher.iteritems() %}
                                    <div class="col-lg-4">
                                        <div class="ibox ">
                                            <div class="ibox-title">
                                                <h5 class="pull-left">{{ k }}</h5>
                                            </div>
                                            <div class="ibox-content">
                                                <iframe src="{{ v }}" width="300" height="250"></iframe>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        <!-- Drugs Panel End-->

        <!-- Signature Panel Start-->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox ">
                            <div class="ibox-title" style="background: #009ece; color: white;">
                                <h5 class="pull-left">Disease Signature</h5>
                            </div>
                            <div class="ibox-content">
                                {% if signature_file %}
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="ibox ">
                                            <div class="ibox-content">
                                                <iframe src="{{ signature_file }}" width="1050" height="400"></iframe>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if job.jobs.0.de_method == 'edgeR' %}
                                    <div class="row">
                                        {% for dz in dz_enricher %}
                                            <div class="col-lg-4">
                                                <div class="ibox ">
                                                    <div class="ibox-content">
                                                        <iframe src="{{ dz }}" width="300" height="250"></iframe>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% elif job.jobs.0.de_method == 'limma' %}
                                    <div class="row">
                                        {% for dz in dz_enricher %}
                                            <div class="col-lg-6">
                                                <div class="ibox ">
                                                    <div class="ibox-content">
                                                        <iframe src="{{ dz }}" width="300" height="250"></iframe>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
        <!-- Signature Panel End-->

        <!-- Case-COntrol Panel Start-->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox ">
                            <div class="ibox-title" style="background: #009ece; color: white;">
                                <h5 class="pull-left">Control Samples</h5>
                            </div>
                            <div class="ibox-content">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="ibox ">
                                            <div class="ibox-content">
                                                <div id="control_plot_output"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        <!-- Case-COntrol Panel End-->

        <!-- Case Panel Start-->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox ">
                            <div class="ibox-title" style="background: #009ece; color: white;">
                                <h5 class="pull-left">Case Samples</h5>
                            </div>
                            <div class="ibox-content">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="ibox ">
                                            <div class="ibox-content">
                                                <div id="case_plot_output"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        <!-- Case Panel End-->


        <!--   Drug hits -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox ">
                            <div class="ibox-title">
                                <h5 class="pull-left">Drug Hits</h5>
                            </div>
                            <div class="ibox-content">
                                <table id="drug_hits" class="table table-striped table-bordered display nowrap" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Pert iname</th>
                                            <th>Clinical Phase</th>
                                            <th>MOA</th>
                                            <th>Target</th>
                                            <th>sRGE</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>ABT-491</td>
                                            <td>Phase 1</td>
                                            <td>platelet activating factor receptor</td>
                                            <td>PTAFR</td>
                                            <td>-0.54(o)</td>
                                        </tr>
                                        <tr>
                                            <td>acefylline</td>
                                            <td>Launched</td>
                                            <td>adenosine receptor agonist</td>
                                            <td>ADORA1</td>
                                            <td>-0.42(o)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
    		</div>
        </div>
        {% include 'base/footer.html' %}
    </div>
    {% include 'base/js_links.html' %}


    <script type="text/javascript">
        var case_plot = function(){
			var case_str = ''
			{% if job and job.jobs.0.case_sample_id %}
				case_str = "{{ job.jobs.0.case_sample_id }}"
			{% endif %}
			$("#case_samples").val(case_str);
			case_data = {"cases": case_str};
			$.ajax({
				dataType: "json",
				type: "POST",
				url: "{{ url_for('api.case_plot') }}",
				data: JSON.stringify(case_data),
				async: false,
				success: function(data){
					Plotly.newPlot('case_plot_output', data.graph_data, data.layout);
				}
			});
		};

		var control_plot = function(){

			var case_str = ''
			{% if job and job.jobs.0.case_sample_id %}
				case_str = "{{ job.jobs.0.case_sample_id }}"
			{% endif %}
			$("#case_samples").val(case_str);
			var control_str = ''
			{% if job and job.jobs.0.ctrl_sample_id %}
				control_str = "{{ job.jobs.0.ctrl_sample_id }}"
			{% endif %}
			$("#control_samples").val(control_str);
			control_data = {"cases": case_str, "controls": control_str};
			$.ajax({
				dataType: "json",
				type: "POST",
				url: "{{ url_for('api.control_plot') }}",
				data: JSON.stringify(control_data),
				async: false,
				success: function(data){
					Plotly.newPlot('control_plot_output', data.graph_data, data.layout);
				}
			});
		};

    $(document).ready(function(){
        case_plot();
        control_plot();
    });

    $("#drugsFiles").click(function(){
        /*window.location.href = "{{ url_for('static', filename='data/36/DE_genes.csv') }}";
        window.location.href = "{{ url_for('static', filename='data/36/DE_genes.csv') }}";*/
        download_files([{ download: "/" + "{{ file_name }}", filename : "{{ file_name }}"}]);
    })


    function download_files(files) {
      function download_next(i) {
        if (i >= files.length) {
          return;
        }
        var a = document.createElement('a');
        a.href = "/static/data/"+{{job.id}}+files[i].download;
        a.target = '_parent';
        if ('download' in a) {
          a.download = files[i].filename;
        }
        (document.body || document.documentElement).appendChild(a);
        if (a.click) {
          a.click();
        } else {
          $(a).click();
        }
        a.parentNode.removeChild(a);

        setTimeout(function() {
          download_next(i + 1);
        }, 2500);
      }
      download_next(0);
    }

</script>

</body>
</html>
