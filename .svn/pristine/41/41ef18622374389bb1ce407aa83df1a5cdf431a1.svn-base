from flask import g
from sqlalchemy import Column, Integer, String, ForeignKey, TIMESTAMP, Boolean, TEXT
from sqlalchemy.orm import relationship, backref
from models.base import CRUDMixin, db


STATUS = {0: 'Created', 1: 'Case Visualization', 2: 'Ref Tissue Algo Run', 3: 'Control Visualization',
		4: 'Signature Compute', 5: 'Drug Predection In-progress', 6: 'Completed'}

FEATURES = {1: 'Tissue Type', 2: 'Site', 3: 'Gender', 4: 'Metastatic Site', 5: 'EGFR',
			6: 'IDH1', 7: 'IDH2', 8: 'TP53', 9: 'Age', 10: 'Tumor Grade', 11: 'Tumor Stage'}


class Samples(CRUDMixin, db.Model):
	"""
		Sample info is nothing but predefined data by application
	"""
	id = Column(Integer, primary_key=True, autoincrement=True)
	sample_id = Column(String(100), nullable=False)
	tissue_type = Column(String(50), nullable=False)
	site = Column(String(50), nullable=False)
	gender = Column(String(10), nullable=False)
	metastatic_site = Column(String(10), nullable=False)
	cancer = Column(String(100), nullable=False)
	EGFR = Column(Boolean, nullable=False)
	IDH1 = Column(Boolean, nullable=False)
	IDH2 = Column(Boolean, nullable=False)
	TP53 = Column(Boolean, nullable=False)
	age_in_year = Column(Integer, nullable=True)
	tumor_grade = Column(String(100), nullable=True)
	tumor_stage = Column(String(100), nullable=True)


class Job(CRUDMixin, db.Model):
	"""
		Job Info created by user
	"""
	id = Column(Integer, primary_key=True, autoincrement=True)
	user_id = Column(Integer, ForeignKey('portaluser.id'), nullable=True)
	name = Column(String(50))
	status = Column(Integer, nullable=False, default=0)
	creationTime = Column(TIMESTAMP, nullable=False)
	description = Column(TEXT, nullable=True)
	is_save = Column(Boolean, default=False)

	userDetails = relationship("User", backref=backref("users"))

	@staticmethod
	def get_new_id():
		try:
			# lastrowid = Job.query.order_by('-id').first().id
			# print lastrowid
			# return lastrowid + 1
			if g.user:
				job = Job(name='new_job', user_id=g.user.id)
			else:
				job = Job(name='new_job')
			job.save()
			jobDetails = JobDetails(job_id=job.id)
			jobDetails.save()
			return job.id
		except Exception as e:
			print str(e)
			return 1


class JobDetails(CRUDMixin, db.Model):
	id = Column(Integer, primary_key=True, autoincrement=True)
	job_id = Column(Integer, ForeignKey('job.id', ondelete='cascade'))
	creationTime = Column(TIMESTAMP, nullable=False)
	disease_name = Column(String(200), nullable=True)
	case_sample_id = Column(TEXT, nullable=True)
	case_tissue_type = Column(String(50), nullable=True)
	case_site = Column(String(50), nullable=True)
	case_gender = Column(String(10), nullable=True)
	case_metastatic_site = Column(String(10), nullable=True)
	case_EGFR = Column(Boolean, nullable=True, default=0)
	case_IDH1 = Column(Boolean, nullable=True, default=0)
	case_IDH2 = Column(Boolean, nullable=True, default=0)
	case_TP53 = Column(Boolean, nullable=True, default=0)
	case_age_in_year = Column(String(50), nullable=True)
	case_tumor_grade = Column(String(100), nullable=True)
	case_tumor_stage = Column(String(100), nullable=True)
	ctrl_sample_id = Column(TEXT, nullable=True)
	ctrl_tissue_type = Column(String(50), nullable=True)
	ctrl_site = Column(String(50), nullable=True)
	ctrl_gender = Column(String(10), nullable=True)
	ctrl_metastatic_site = Column(String(10), nullable=True)
	ctrl_EGFR = Column(Boolean, nullable=True, default=0)
	ctrl_IDH1 = Column(Boolean, nullable=True, default=0)
	ctrl_IDH2 = Column(Boolean, nullable=True, default=0)
	ctrl_TP53 = Column(Boolean, nullable=True, default=0)
	ctrl_age_in_year = Column(String(50), nullable=True)
	ctrl_tumor_grade = Column(String(100), nullable=True)
	ctrl_tumor_stage = Column(String(100), nullable=True)
	de_method = Column(String(50), nullable=True)
	dz_fc_threshold = Column(String(50), nullable=True)
	dz_p_threshold = Column(String(50), nullable=True)
	database = Column(String(50), nullable=True)
	choose_fda_drugs = Column(String(10), nullable=True)
	max_gene_size = Column(String(50), nullable=True)
	landmark = Column(String(50), nullable=True)
	weight_cell_line = Column(String(10), nullable=True)
	debug = Column(String(10), nullable=True)

	jobDetails = relationship("Job", backref=backref("jobs"))


def get_sites():
	sites = db.session.query(Samples.site).order_by(Samples.site.asc()).distinct().all()
	return [s[0] for s in sites if s[0] and s[0] != '<NOT PROVIDED>']


def get_metastatics():
	metastatics = db.session.query(Samples.metastatic_site).order_by(Samples.metastatic_site.asc()).distinct().all()
	return [m[0] for m in metastatics if m[0]]


def get_grades():
	grades = db.session.query(Samples.tumor_grade).order_by(Samples.tumor_grade.asc()).distinct().all()
	return [g[0] for g in grades if g[0]]


def get_stages():
	stages = db.session.query(Samples.tumor_stage).order_by(Samples.tumor_stage.asc()).distinct().all()
	return [s[0] for s in stages if s[0]]


def get_diseases():
	diseases = db.session.query(Samples.cancer).order_by(Samples.cancer.asc()).distinct().all()
	return [d[0] for d in diseases if d[0]]
